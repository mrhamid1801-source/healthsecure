<script>
    // Get role from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roleFromUrl = urlParams.get('role');
    
    // Initialize AWS Simulator
    const aws = new AWSCredentialsSimulator();
    
    function selectRole(role) {
        // Remove selected class from all options
        document.querySelectorAll('.role-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Add selected class to clicked option
        document.getElementById(role + 'Option').classList.add('selected');
        
        // Update IAM Role display
        document.getElementById('iamRole').value = role.charAt(0).toUpperCase() + role.slice(1) + 'Role';
        document.getElementById('roleArn').value = aws.roles[role].roleArn;
        
        // Store in session storage
        sessionStorage.setItem('selectedRole', role);
    }
    
    async function login() {
        const role = sessionStorage.getItem('selectedRole') || 'patient';
        const mfaCode = document.getElementById('mfaCode').value;
        const username = document.getElementById('username').value;
        
        if (!username) {
            showError('Please enter username');
            return;
        }
        
        if (!mfaCode || mfaCode.length !== 6) {
            showError('Please enter valid 6-digit MFA code');
            return;
        }
        
        // Show loading
        const loginBtn = document.querySelector('button[onclick="login()"]');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating with AWS STS...';
        loginBtn.disabled = true;
        
        try {
            // Simulate AWS STS AssumeRole with MFA
            const credentials = await aws.assumeRole(role, mfaCode);
            
            // Store user info
            sessionStorage.setItem('username', username);
            sessionStorage.setItem('loginTime', new Date().toLocaleString());
            
            // Show success message
            showSuccess('Successfully authenticated! Assuming IAM Role...');
            
            // Redirect to appropriate dashboard after delay
            setTimeout(() => {
                switch(role) {
                    case 'patient':
                        window.location.href = 'patient-dashboard.html';
                        break;
                    case 'doctor':
                        window.location.href = 'doctor-dashboard.html';
                        break;
                    case 'admin':
                        window.location.href = 'admin-panel.html';
                        break;
                }
            }, 1500);
            
        } catch (error) {
            showError(error.message);
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage') || createMessageDiv('errorMessage', 'danger');
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage') || createMessageDiv('successMessage', 'success');
        successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        successDiv.style.display = 'block';
    }
    
    function createMessageDiv(id, type) {
        const div = document.createElement('div');
        div.id = id;
        div.className = `alert alert-${type} mt-3`;
        div.style.display = 'none';
        document.querySelector('.login-card').appendChild(div);
        return div;
    }
    
    // Initialize based on URL parameter
    if (roleFromUrl && ['patient', 'doctor', 'admin'].includes(roleFromUrl)) {
        selectRole(roleFromUrl);
    } else {
        selectRole('patient');
    }
    
    // Add MFA input dynamically
    document.addEventListener('DOMContentLoaded', function() {
        const mfaBox = document.querySelector('.mfa-box');
        mfaBox.innerHTML = `
            <h6><i class="fas fa-mobile-alt me-2"></i> AWS IAM MFA Authentication Required</h6>
            <p class="small mb-2">Your IAM role requires Multi-Factor Authentication. Enter the 6-digit code from your virtual MFA device.</p>
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-shield-alt"></i>
                </span>
                <input type="text" class="form-control" id="mfaCode" placeholder="000000" maxlength="6" pattern="\\d{6}">
                <button class="btn btn-outline-secondary" type="button" onclick="generateMFACode()">
                    <i class="fas fa-sync-alt"></i> Simulate MFA
                </button>
            </div>
            <div id="mfaDeviceInfo" class="mt-2 small text-muted">
                <i class="fas fa-mobile-alt"></i> Virtual MFA Device: Authy/Google Authenticator
            </div>
        `;
        
        // Add role ARN display
        const roleField = document.querySelector('#iamRole').parentElement;
        const arnHtml = `
            <div class="mb-3">
                <label class="form-label fw-bold">IAM Role ARN</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fab fa-aws"></i>
                    </span>
                    <input type="text" class="form-control" id="roleArn" value="${aws.roles.patient.roleArn}" readonly>
                    <button class="btn btn-outline-info" type="button" onclick="copyToClipboard('roleArn')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <small class="text-muted">AWS IAM Role Amazon Resource Name</small>
            </div>
        `;
        roleField.insertAdjacentHTML('afterend', arnHtml);
    });
    
    function generateMFACode() {
        // Generate a random 6-digit code (simulating MFA device)
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('mfaCode').value = code;
        
        // Show notification
        const infoDiv = document.getElementById('mfaDeviceInfo');
        infoDiv.innerHTML = `<i class="fas fa-check text-success"></i> MFA Code Generated: ${code} (Valid for 30 seconds)`;
        infoDiv.className = 'mt-2 small text-success';
        
        setTimeout(() => {
            infoDiv.innerHTML = `<i class="fas fa-mobile-alt"></i> Virtual MFA Device: Authy/Google Authenticator`;
            infoDiv.className = 'mt-2 small text-muted';
        }, 30000);
    }
    
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        document.execCommand('copy');
        
        // Show copied notification
        const originalText = element.nextElementSibling.innerHTML;
        element.nextElementSibling.innerHTML = '<i class="fas fa-check"></i> Copied to clipboard!';
        
        setTimeout(() => {
            element.nextElementSibling.innerHTML = originalText;
        }, 2000);
    }
</script>
